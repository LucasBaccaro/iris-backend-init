## **SPRINT 1: Configuración de Entorno y Esquema de Base de Datos Base**

**Objetivo del Sprint:** Tener un proyecto FastAPI inicializado, un entorno de desarrollo funcional, un repositorio configurado, y el esquema de base de datos básico (incluyendo `user_profiles`) definido en Supabase y listo para usar.

**1\. Configuración del Entorno y Repositorio**

*   **1.1. Tarea: Crear el repositorio de GitHub y configurar el control de versiones.**
    *   **Prompt para el Agente:** "Asegura que el repositorio `iris-backend` esté creado en GitHub bajo la organización/cuenta especificada. Configura un flujo de trabajo de Git (ej., `git-flow` simplificado o `main` + `feature branches`) y un archivo `.gitignore` adecuado para proyectos Python/FastAPI, excluyendo dependencias (`venv/`, `__pycache__/`, `.env`) y archivos sensibles."
    *   **Entregable:** Repositorio de GitHub inicializado con estructura básica y `.gitignore`.
    *   **Testing:** Verificación manual de la existencia y configuración del repositorio.
*   **1.2. Tarea: Configurar el entorno de desarrollo local con Python 3.11.**
    *   **Prompt para el Agente:** "Crea un entorno virtual de Python (`venv`) para el proyecto y actívalo. Instala las versiones de Python 3.11 en el entorno de desarrollo. Asegura que la estructura de directorios inicial sea `src/` para el código fuente, y subdirectorios como `src/core/`, `src/api/`, `src/db/`, `src/schemas/`, `src/models/`, `src/utils/` dentro de `src/`."
    *   **Entregable:** Entorno virtual de Python 3.11 configurado y estructura de directorios básica.
    *   **Testing:** Ejecución de `python --version` dentro del `venv` para confirmar 3.11. Verificación de la estructura de carpetas.
*   **1.3. Tarea: Inicializar el proyecto FastAPI.**
    *   **Prompt para el Agente:** "Dentro de `src/`, crea el archivo `main.py`. Configura una aplicación FastAPI básica con un `middleware` para CORS (permitiendo orígenes específicos, métodos y encabezados, especialmente `Authorization`). Incluye un `middleware` para el manejo de excepciones global y un endpoint de salud (`/health`) que retorne un estado HTTP 200."
    *   **Entregable:** `src/main.py` con FastAPI configurado, CORS, middleware de errores, y `/health` endpoint.
    *   **Testing:** Inicio de la aplicación (`uvicorn src.main:app --reload`) y acceso a `/health` desde un navegador/cliente HTTP para verificar el estado 200 y el funcionamiento de CORS con un origen diferente.
*   **1.4. Tarea: Crear el archivo `requirements.txt` con las dependencias necesarias.**
    *   **Prompt para el Agente:** "Identifica e instala las dependencias iniciales para FastAPI, Supabase, autenticación JWT y testing. Crea un archivo `requirements.txt` con estas dependencias. Las dependencias mínimas requeridas incluyen: `fastapi`, `uvicorn[standard]`, `python-jose[cryptography]`, `passlib[bcrypt]`, `supabase-py`, `pydantic`, `psycopg2-binary` (o `asyncpg`), `python-dotenv`, `pytest`, `httpx`."
    *   **Entregable:** `requirements.txt` con las dependencias listadas y confirmación de su instalación.
    *   **Testing:** Ejecución de `pip install -r requirements.txt` en un entorno virtual limpio para verificar que todas las dependencias se instalan sin errores.

**2\. Setup de Supabase y Migraciones**

*   **2.1. Tarea: Configurar un nuevo proyecto en Supabase.**
    *   **Prompt para el Agente:** "Asegura que un proyecto de Supabase esté aprovisionado y que se tenga acceso a su 'Project URL' y 'Anon Key' y 'Service Role Key'. Estas claves se deben almacenar de forma segura (ej. en un archivo `.env` local para desarrollo y variables de entorno en producción)."
    *   **Entregable:** Confirmación de acceso a las credenciales de Supabase.
    *   **Testing:** Ping básico a la API de Supabase desde un script Python con las claves.
*   **2.2. Tarea: Diseñar y crear el esquema inicial de la base de datos, incluyendo la tabla `user_profiles`.**
    *   **Prompt para el Agente:** "Diseña y proporciona el script SQL completo para la creación de las tablas principales (`businesses`, `employees`, `services`, `promotions`, `appointments`) con sus columnas, tipos de datos, claves primarias/foráneas, y constraints. **Enfócate en la tabla `user_profiles` con la siguiente estructura y lógica:**
        *   `CREATE TABLE public.user_profiles (`
        *   `id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,`
        *   `role TEXT NOT NULL DEFAULT 'customer' CHECK (role IN ('owner', 'employee', 'customer')),`
        *   `business_id UUID REFERENCES public.businesses(id) ON DELETE SET NULL,`
        *   `first_name TEXT,`
        *   `last_name TEXT,`
        *   `phone_number TEXT UNIQUE,`
        *   `created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP`
        *   `);`
        *   Asegura que el `business_id` en `user_profiles` sea `NULLable` para soportar clientes generales o propietarios antes de crear su primer negocio. Incluye las relaciones con las otras tablas (ej. `employees` referenciando `user_profiles.id`, `appointments` referenciando `user_profiles.id` como `customer_id` y `employee_id`). Define las políticas de Row Level Security (RLS) básicas para `user_profiles` y `businesses` (ej. `SELECT` a todos para `customer`, `ALL` para `owner`/`employee` en su `business_id`)."
    *   **Entregable:** Script SQL completo para la creación del esquema y configuración de RLS iniciales. Ejecución exitosa de este script en Supabase.
    *   **Testing:** Escribir un script SQL para verificar la existencia de todas las tablas, columnas, claves y constraints. Intentar insertar datos que violen las constraints (ej., rol inválido, `id` de usuario inexistente) para confirmar su funcionamiento.
*   **2.3. Tarea: Implementar un sistema de migraciones para la base de datos (con Alembic).**
    *   **Prompt para el Agente:** "Configura Alembic para el proyecto. Inicializa Alembic y genera la migración inicial que refleje el esquema actual de Supabase (es decir, el script SQL de la tarea anterior). Aplica esta migración para confirmar que Alembic está configurado correctamente para detectar cambios futuros. Asegura que el archivo de configuración de Alembic (`alembic.ini`) esté adaptado para la conexión a PostgreSQL de Supabase."
    *   **Entregable:** Configuración de Alembic en el proyecto, migración inicial generada y aplicada.
    *   **Testing:** Ejecutar `alembic revision --autogenerate -m "Initial schema"` y `alembic upgrade head`. Verificar que no haya errores y que el estado de la base de datos sea el esperado.

---