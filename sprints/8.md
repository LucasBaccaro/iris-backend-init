## **SPRINT 8: Notificaciones y Manejo de Timezones**

**Objetivo del Sprint:** Implementar un sistema de notificaciones por correo electrónico para confirmaciones y recordatorios, y asegurar un manejo consistente de las zonas horarias en toda la aplicación.

**2\. Notificaciones**

*   **2.1. Tarea: Integrar un servicio de envío de correos electrónicos.**
    *   **Prompt para el Agente:** "Integra un cliente para un servicio de envío de correos electrónicos transaccionales (ej., Postmark, SendGrid, o el servicio de correo de Supabase si aplica) en la capa de utilidades (`src/utils/`). Configura las credenciales de la API de forma segura (variables de entorno). Implementa una función genérica `send_email(to_email, subject, body_html)`."
    *   **Entregable:** Cliente de correo electrónico configurado y función genérica de envío.
    *   **Testing:** Enviar un correo electrónico de prueba básico para verificar la integración.
*   **2.2. Tarea: Crear una tarea asíncrona para notificaciones de reserva y recordatorios.**
    *   **Prompt para el Agente:** "Implementa una tarea asíncrona (ej., utilizando Celery, RQ o un `background task` de FastAPI para el MVP) que:
        1.  Envía una confirmación por correo electrónico al `customer` y `employee` cuando se crea una `appointment`.
        2.  Implementa un `scheduler` (ej., `APScheduler` o un `cron job` si se usa Celery) para enviar recordatorios por correo electrónico 24 horas antes de cada `appointment`."
    *   **Entregable:** Tarea asíncrona para notificaciones y sistema de recordatorios configurado.
    *   **Testing:**
        *   **Integración:** Crear una cita y verificar que los correos de confirmación se envían correctamente.
        *   **Funcional:** Probar el scheduler (si es un componente de prueba) o simular la ejecución del cron job para verificar el envío de recordatorios.

**3\. Manejo de Timezones**

*   **3.1. Tarea: Implementar la lógica para el manejo de zonas horarias.**
    *   **Prompt para el Agente:** "Asegura que todas las operaciones de fecha y hora en el backend sigan la siguiente política:
        1.  **Almacenamiento:** Todas las fechas y horas se guardan en la base de datos en **UTC**.
        2.  **Input/Output (API):** Los endpoints de la API deben aceptar y devolver fechas y horas en formato ISO 8601 con información de zona horaria (o asumir UTC si no se especifica y luego convertir).
        3.  **Presentación:** Al mostrar fechas y horas al `owner`/`employee`/`customer`, se deben adaptar a la `timezone` configurada para el `business` (ej., en una columna `timezone` en la tabla `businesses`).
        Utiliza una librería como `pytz` o `zoneinfo` para las conversiones. Implementa utilidades (`src/utils/time.py`) para convertir entre UTC y la zona horaria del negocio."
    *   **Entregable:** Funciones de utilidad para el manejo de zonas horarias y su aplicación consistente en los modelos Pydantic y lógica de base de datos.
    *   **Testing:** Escribir pruebas unitarias para las funciones de conversión de zona horaria. Pruebas de integración para endpoints que manejan fechas/horas, enviando y recibiendo datos con diferentes zonas horarias, y verificando que se almacenan/muestran correctamente.

---